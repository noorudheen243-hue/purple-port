name: Auto Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VPS using SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            cd /var/www/purple-port
            git fetch --all
            git reset --hard origin/main
            chmod +x deploy_update.sh
            bash deploy_update.sh

      - name: Verify Deployment on VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            echo "=== Nginx config root ==="
            grep -r "root " /etc/nginx/sites-enabled/ 2>/dev/null || echo "Could not read nginx config"
            echo "=== Files in client/dist (nginx serves this) ==="
            ls -lht /var/www/purple-port/client/dist/ | head -10
            echo "=== index.html in client/dist modified ==="
            stat /var/www/purple-port/client/dist/index.html 2>/dev/null | grep Modify
            echo "=== Sample JS file check (StaffFormModal) ==="
            ls -lht /var/www/purple-port/client/dist/assets/ | grep -i staff | head -5 || echo "No StaffFormModal file found"
            echo "=== PM2 status ==="
            pm2 list
            echo "=== Verification complete ==="
