import{q as C,u as L,r as N,x as p,j as e}from"./index-CVFz3GnQ.js";import{u as M,a1 as G,a4 as F,i as O,D as V,a as q,d as U,e as W,a6 as H,a7 as j,a8 as _,C as K,l as T}from"./index-MXZ1Fyy1.js";import{F as Q}from"./FormErrorAlert-DfwZ5q27.js";import{S as P}from"./square-pen-Sra3cVmY.js";import"./alert-circle-DVBvcfOk.js";const $=H({title:j().min(3,"Title is required"),description:j().optional(),type:_(["GENERIC","GRAPHIC","VIDEO","COPY","STRATEGY","DEV"]),priority:_(["LOW","MEDIUM","HIGH","URGENT"]),status:_(["PLANNED","ASSIGNED","IN_PROGRESS","REVIEW","REVISION_REQUESTED","COMPLETED"]),due_date:j().optional(),assignee_id:j().optional()}),z=({isOpen:o,onClose:x,task:a})=>{const b=C(),{user:g}=L(),{data:h}=M({queryKey:["users"],queryFn:()=>p.get("/users").then(t=>t.data)}),{register:n,handleSubmit:f,setValue:r,formState:{errors:u},reset:c}=G({resolver:F($),defaultValues:{title:"",priority:"MEDIUM",status:"PLANNED",type:"GENERIC"}});N.useEffect(()=>{a&&c({title:a.title,description:a.description,type:a.type,priority:a.priority,status:a.status,assignee_id:a.assignee_id,due_date:a.due_date?new Date(a.due_date).toISOString().slice(0,10):""})},[a,c]);const m=O({mutationFn:async t=>{const d={...t};return t.due_date&&(d.due_date=new Date(t.due_date)),await p.put(`/tasks/${a.id}`,d)},onSuccess:()=>{b.invalidateQueries({queryKey:["tasks"]}),x()},onError:t=>{var d,s;alert("Failed to update task: "+(((s=(d=t.response)==null?void 0:d.data)==null?void 0:s.message)||t.message))}}),E=t=>{m.mutate(t)};return e.jsx(V,{open:o,onOpenChange:x,children:e.jsxs(q,{className:"max-w-xl bg-white p-0 gap-0",children:[e.jsx(U,{className:"p-6 pb-2 border-b",children:e.jsxs(W,{className:"text-xl font-bold flex items-center gap-2 text-gray-800",children:[e.jsx(P,{className:"text-blue-600"}),"Edit Task"]})}),e.jsxs("form",{onSubmit:f(E),className:"p-6 space-y-4",children:[e.jsx(Q,{errors:u}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Task Title"}),e.jsx("input",{...n("title"),className:"w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-200 outline-none"}),u.title&&e.jsx("p",{className:"text-red-500 text-xs",children:u.title.message})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Status"}),e.jsxs("select",{...n("status"),className:"w-full px-4 py-2 border rounded-lg bg-white",children:[e.jsx("option",{value:"PLANNED",children:"Planned"}),e.jsx("option",{value:"ASSIGNED",children:"Assigned"}),e.jsx("option",{value:"IN_PROGRESS",children:"In Progress"}),e.jsx("option",{value:"REVIEW",children:"Review"}),e.jsx("option",{value:"REVISION_REQUESTED",children:"Revision Requested"}),e.jsx("option",{value:"COMPLETED",children:"Completed"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Priority"}),e.jsxs("select",{...n("priority"),className:"w-full px-4 py-2 border rounded-lg bg-white",children:[e.jsx("option",{value:"LOW",children:"Low"}),e.jsx("option",{value:"MEDIUM",children:"Medium"}),e.jsx("option",{value:"HIGH",children:"High"}),e.jsx("option",{value:"URGENT",children:"Urgent"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Assigned To"}),e.jsxs("select",{...n("assignee_id"),className:"w-full px-4 py-2 border rounded-lg bg-white",children:[e.jsx("option",{value:"",children:"Unassigned"}),h==null?void 0:h.map(t=>e.jsxs("option",{value:t.id,children:[t.full_name," (",t.department,")"]},t.id))]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Due Date"}),e.jsx("input",{type:"date",...n("due_date"),className:"w-full px-4 py-2 border rounded-lg"})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t",children:[e.jsx("button",{type:"button",onClick:x,className:"px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg",children:"Cancel"}),e.jsx("button",{type:"submit",disabled:m.isPending,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50",children:m.isPending?"Saving...":"Save Changes"})]})]})]})})},k=()=>{const[o,x]=N.useState(new Date().toISOString().slice(0,7)),[a,b]=N.useState("ALL"),{data:g,isLoading:h}=M({queryKey:["tasks","board",o,a],queryFn:async()=>{const s={};return o&&(s.start_date=`${o}-01`,s.end_date=new Date(new Date(o).getFullYear(),new Date(o).getMonth()+1,0).toISOString().slice(0,10)),(await p.get("/tasks",{params:s})).data}}),n=g==null?void 0:g.filter(s=>{var l;return a==="ALL"?!0:((l=s.assignee)==null?void 0:l.department)===a}),f=s=>{switch(s){case"COMPLETED":return"text-green-600 bg-green-50 border-green-200";case"IN_PROGRESS":return"text-blue-600 bg-blue-50 border-blue-200";case"REVIEW":return"text-purple-600 bg-purple-50 border-purple-200";case"PLANNED":return"text-gray-500 bg-gray-50 border-gray-200";default:return"text-gray-500 bg-gray-50 border-gray-200"}},{user:r}=L(),u=C(),[c,m]=N.useState(null),E=O({mutationFn:async s=>await p.delete(`/tasks/${s}`),onSuccess:()=>{u.invalidateQueries({queryKey:["tasks"]})},onError:s=>{var i,l;alert(((l=(i=s.response)==null?void 0:i.data)==null?void 0:l.message)||"Failed to delete task")}}),t=s=>{window.confirm("Are you sure you want to delete this task?")&&E.mutate(s)},d=(r==null?void 0:r.department)!=="CREATIVE"&&(r==null?void 0:r.role)!=="CREATIVE_DESIGNER";return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-gray-100",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("h2",{className:"text-xl font-bold text-gray-800 flex items-center gap-2",children:[e.jsx(K,{className:"text-purple-600"}),"Task Board History"]}),e.jsx("input",{type:"month",value:o,onChange:s=>x(s.target.value),className:"bg-gray-50 border border-gray-200 rounded-md px-3 py-1.5 text-sm"})]}),e.jsxs("div",{className:"flex gap-2",children:[((r==null?void 0:r.role)==="ADMIN"||(r==null?void 0:r.role)==="DEVELOPER_ADMIN")&&e.jsxs("button",{onClick:async()=>{var s,i;if(window.confirm("⚠️ DANGER: This will delete ALL tasks, comments, notification, and assets. This cannot be undone. Are you sure?"))try{await p.delete("/tasks/reset-data"),alert("All system data has been wiped."),window.location.reload()}catch(l){console.error(l);const y=((i=(s=l.response)==null?void 0:s.data)==null?void 0:i.message)||l.message||"Failed to reset data";alert(`Failed to reset data: ${y}`)}},className:"bg-red-100 text-red-600 border border-red-200 px-3 py-2 rounded-md font-medium text-xs flex items-center gap-2 hover:bg-red-200 transition-colors",children:[e.jsx(T,{size:14})," Reset Data"]}),e.jsxs("select",{value:a,onChange:s=>b(s.target.value),className:"bg-gray-100 text-gray-700 rounded-md text-sm font-medium px-4 py-2 border-none outline-none",children:[e.jsx("option",{value:"ALL",children:"All Departments"}),e.jsx("option",{value:"MARKETING",children:"Marketing"}),e.jsx("option",{value:"CREATIVE",children:"Creative"}),e.jsx("option",{value:"WEB",children:"Web"})]})]})]}),e.jsx("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 overflow-x-auto",children:e.jsxs("table",{className:"w-full text-left text-sm whitespace-nowrap",children:[e.jsx("thead",{className:"bg-gray-50/50 border-b border-gray-200 font-semibold text-gray-600",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-4",children:"Date & Time"}),e.jsx("th",{className:"p-4",children:"Client / Campaign"}),e.jsx("th",{className:"p-4",children:"Task Name"}),e.jsx("th",{className:"p-4",children:"Type / Nature"}),e.jsx("th",{className:"p-4",children:"Assigned To"}),e.jsx("th",{className:"p-4",children:"Status"}),e.jsx("th",{className:"p-4",children:"Est. vs Actual"}),d&&e.jsx("th",{className:"p-4 text-right",children:"Actions"})]})}),e.jsxs("tbody",{className:"divide-y divide-gray-100",children:[n==null?void 0:n.map(s=>{var i,l,y,D,S,R,A,I;return e.jsxs("tr",{className:"hover:bg-gray-50/30",children:[e.jsxs("td",{className:"p-4 text-gray-500",children:[e.jsx("div",{className:"font-medium text-gray-900",children:(s.actual_start_date||s.createdAt).slice(0,10)}),e.jsx("div",{className:"text-xs text-gray-400",children:new Date(s.actual_start_date||s.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]}),e.jsxs("td",{className:"p-4",children:[e.jsx("div",{className:"font-medium text-gray-800",children:((l=(i=s.campaign)==null?void 0:i.client)==null?void 0:l.name)||((y=s.client)==null?void 0:y.name)||"General Task"}),e.jsx("div",{className:"text-xs text-gray-400",children:((D=s.campaign)==null?void 0:D.title)||"No Campaign"})]}),e.jsx("td",{className:"p-4 font-medium text-gray-900",children:s.title}),e.jsxs("td",{className:"p-4",children:[e.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800 mr-2",children:s.type}),s.nature==="REWORK"&&e.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800",children:"REWORK"})]}),e.jsx("td",{className:"p-4",children:e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("div",{className:"flex items-center gap-2",children:s.assignee?e.jsxs(e.Fragment,{children:[s.assignee.avatar_url?e.jsx("img",{src:s.assignee.avatar_url,className:"w-6 h-6 rounded-full"}):e.jsx("div",{className:"w-6 h-6 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-xs font-bold",children:((S=s.assignee.full_name)==null?void 0:S.charAt(0))||"?"}),e.jsx("span",{className:"text-gray-700",children:s.assignee.full_name.split(" ")[0]})]}):e.jsx("span",{className:"text-gray-400 italic",children:"Unassigned"})}),e.jsx("div",{className:"text-xs text-gray-400",children:e.jsxs("span",{children:["by ",((R=s.assigned_by)==null?void 0:R.full_name)||"System"]})})]})}),e.jsx("td",{className:"p-4",children:e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-bold border ${f(s.status)}`,children:s.status.replace("_"," ")})}),e.jsxs("td",{className:"p-4 text-gray-600",children:[((A=s.timeLogs)==null?void 0:A.reduce((v,w)=>v+(w.duration_minutes||0),0))>0||s.actual_time_minutes>0?e.jsxs("span",{className:(s.actual_time_minutes||0)>s.estimated_hours*60?"text-red-600 font-bold":"text-green-600 font-bold",children:[s.actual_time_minutes||((I=s.timeLogs)==null?void 0:I.reduce((v,w)=>v+(w.duration_minutes||0),0)),"m"]}):e.jsx("span",{className:"text-gray-400",children:"-"}),e.jsx("span",{className:"text-gray-300 mx-1",children:"/"}),e.jsx("span",{className:"text-gray-500 font-medium",children:s.estimated_hours?Math.round(s.estimated_hours*60)+"m":"N/A"})]}),d&&e.jsx("td",{className:"p-4 text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("button",{onClick:()=>m(s),className:"p-1.5 text-blue-600 hover:bg-blue-50 rounded-md transition-colors",title:"Edit Task",children:e.jsx(P,{size:16})}),e.jsx("button",{onClick:()=>t(s.id),className:"p-1.5 text-red-600 hover:bg-red-50 rounded-md transition-colors",title:"Delete Task",children:e.jsx(T,{size:16})})]})})]},s.id)}),(n==null?void 0:n.length)===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:d?8:7,className:"p-8 text-center text-gray-500",children:"No history for this month."})})]})]})}),c&&e.jsx(z,{isOpen:!!c,onClose:()=>m(null),task:c})]})};export{k as default};
