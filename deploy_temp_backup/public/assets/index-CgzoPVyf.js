import{q as J,r as n,x as E,j as e}from"./index-CVFz3GnQ.js";import{T as ce,a as re,b as K,c as Y}from"./tabs-Dihxgigl.js";import{j as V,u as X,i as ee,I as p,B as h,l as oe,P as de,D as ue,b as me,Q as he,a as xe,Y as pe,ag as je,Z as ve}from"./index-MXZ1Fyy1.js";import{C as _,a as A,b as P,c as R}from"./card-L7c9AA96.js";import{L as v}from"./label-BDi2E6m5.js";import{S as L,a as G,b as z,c as $,d as I}from"./select-CRNC5CBq.js";import{S as ge}from"./save-Ch7_aoOB.js";import{B as ye}from"./badge-DB3i4Vcz.js";import{T as be,a as fe,b as U,c as f,d as Ne,e as g}from"./table-DEHLnAz_.js";import{f as Z}from"./format-D4js0obD.js";import{I as we}from"./InvoiceTemplate-Cql7gZi_.js";import Ce from"./html2canvas.esm-CBrSDip1.js";import{E as De}from"./jspdf.es.min-BjSK_EZa.js";import{C as Se}from"./check-circle-C7q7Y3EO.js";import{P as Te}from"./printer-DRzDhpol.js";import"./index-CGf8YfUr.js";import"./index-C_y8q7n2.js";import"./index-COFXZIMB.js";const Ie=["Service Charges – Meta","Service Charges – Google Ads","Service Charges – SEO","Website Development","Website Modification","Creatives","Printables","Branding Assets","Logo Design / Branding Package","Video Production","Studio Charge","Equipment Rent","Anchor Charge","Motion Graphic Production","AI Video Production","Poster Design","Other"],_e=()=>{const M=J(),[c,O]=n.useState("ONBOARDED"),[d,C]=n.useState(""),[D,N]=n.useState(""),[j,B]=n.useState(V(new Date,"yyyy-MM-dd")),[S,t]=n.useState("");n.useEffect(()=>{if(j){const s=new Date(j);s.setDate(s.getDate()+7),t(V(s,"yyyy-MM-dd"))}},[j]);const[l,u]=n.useState([{sl_no:1,particulars:"",description:"",quantity:1,rate:0,amount:0,ledger_id:""}]),[r,y]=n.useState(0),[x,se]=n.useState(0),[te,Pe]=n.useState("Previous Balance"),[w,b]=n.useState(0),[ae,Re]=n.useState("Advance Received"),[H,q]=n.useState(0),{data:k=[]}=X({queryKey:["clients"],queryFn:async()=>{const{data:s}=await E.get("/clients");return s},enabled:c==="ONBOARDED"}),[m,Q]=n.useState(0);n.useEffect(()=>{if(c==="ONBOARDED"&&d){const s=k.find(a=>a.id===d);if(s){N(s.company_name||s.name);const a=s.advance_balance||0;Q(a),a>0?b(a):b(0)}}else Q(0),b(0)},[d,c,k]),n.useEffect(()=>{l.map(s=>{const a=s.quantity*s.rate;return{...s,amount:a}})},[]);const T=(s,a,i)=>{const o=[...l];o[s]={...o[s],[a]:i},(a==="quantity"||a==="rate")&&(o[s].amount=Number(o[s].quantity)*Number(o[s].rate)),u(o),W(o)},W=s=>{const a=s.reduce((i,o)=>i+o.amount,0);y(a),q(a+Number(x)-Number(w))};n.useEffect(()=>{q(r+Number(x)-Number(w))},[r,x,w]);const ne=()=>{u([...l,{sl_no:l.length+1,particulars:"",description:"",quantity:1,rate:0,amount:0,ledger_id:""}])},ie=s=>{if(l.length===1)return;const a=l.filter((i,o)=>o!==s).map((i,o)=>({...i,sl_no:o+1}));u(a),W(a)},F=ee({mutationFn:async s=>await E.post("/billing/invoices",s),onSuccess:()=>{alert("Invoice Generated Successfully!"),M.invalidateQueries({queryKey:["invoices"]}),u([{sl_no:1,particulars:"",description:"",quantity:1,rate:0,amount:0,ledger_id:""}]),y(0),q(0)},onError:s=>{alert("Failed to generate invoice."),console.error(s)}}),le=()=>{if(!D){alert("Client Name is required");return}const s={client_type:c,client_id:c==="ONBOARDED"?d:null,client_name:D,invoice_date:j,due_date:S,items:l,sub_total:r,additions_total:x,additions_desc:te,deductions_total:w,deductions_desc:ae,net_payable:H};F.mutate(s)};return e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs(_,{children:[e.jsx(A,{children:e.jsx(P,{children:"Invoice Details"})}),e.jsxs(R,{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{children:"Client Type"}),e.jsxs(L,{value:c,onValueChange:s=>O(s),children:[e.jsx(G,{children:e.jsx(z,{})}),e.jsxs($,{children:[e.jsx(I,{value:"ONBOARDED",children:"Onboarded Client"}),e.jsx(I,{value:"WALKIN",children:"Walk-in Client"})]})]})]}),c==="ONBOARDED"?e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{children:"Select Client"}),e.jsxs(L,{value:d,onValueChange:C,children:[e.jsx(G,{children:e.jsx(z,{placeholder:"Search Client..."})}),e.jsx($,{children:k.map(s=>e.jsx(I,{value:s.id,children:s.company_name||s.name},s.id))})]})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{children:"Client Name"}),e.jsx(p,{value:D,onChange:s=>N(s.target.value),placeholder:"Type client name..."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{children:"Invoice Date"}),e.jsx(p,{type:"date",value:j,onChange:s=>B(s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{children:"Due Date"}),e.jsx(p,{type:"date",value:S,readOnly:!0,className:"bg-muted"})]})]})]}),e.jsxs(_,{children:[e.jsx(A,{children:e.jsx(P,{children:"Items"})}),e.jsxs(R,{className:"space-y-4",children:[l.map((s,a)=>e.jsxs("div",{className:"grid grid-cols-12 gap-2 items-start border-b pb-4",children:[e.jsx("div",{className:"col-span-1 text-center pt-3 text-sm font-medium text-gray-500",children:s.sl_no}),e.jsxs("div",{className:"col-span-4 space-y-2",children:[e.jsxs(L,{value:s.particulars,onValueChange:i=>T(a,"particulars",i),children:[e.jsx(G,{children:e.jsx(z,{placeholder:"Select Service"})}),e.jsx($,{children:Ie.map(i=>e.jsx(I,{value:i,children:i},i))})]}),e.jsx(p,{placeholder:"Description (Optional)",value:s.description,onChange:i=>T(a,"description",i.target.value),className:"text-xs h-8"})]}),e.jsx("div",{className:"col-span-2",children:e.jsx(p,{type:"number",placeholder:"Qty",value:s.quantity,onChange:i=>T(a,"quantity",parseFloat(i.target.value)||0)})}),e.jsx("div",{className:"col-span-2",children:e.jsx(p,{type:"number",placeholder:"Rate",value:s.rate,onChange:i=>T(a,"rate",parseFloat(i.target.value)||0)})}),e.jsx("div",{className:"col-span-2 text-right pt-2 font-bold font-mono",children:s.amount.toFixed(2)}),e.jsx("div",{className:"col-span-1 text-center",children:e.jsx(h,{variant:"ghost",size:"icon",onClick:()=>ie(a),disabled:l.length===1,className:"text-destructive hover:text-red-600",children:e.jsx(oe,{className:"h-4 w-4"})})})]},a)),e.jsxs(h,{variant:"outline",size:"sm",onClick:ne,className:"w-full border-dashed",children:[e.jsx(de,{className:"h-4 w-4 mr-2"})," Add Item"]})]})]})]}),e.jsx("div",{className:"space-y-6",children:e.jsxs(_,{children:[e.jsx(A,{children:e.jsx(P,{children:"Summary"})}),e.jsxs(R,{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Sub Total"}),e.jsx("span",{className:"font-bold",children:r.toFixed(2)})]}),e.jsxs("div",{className:"space-y-4 border-t pt-4",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx(v,{className:"text-gray-600 font-normal",children:"Additions (Previous Balance)"}),e.jsx(p,{type:"number",placeholder:"0.00",value:x||"",onChange:s=>se(parseFloat(s.target.value)||0),className:"w-32 text-right h-8"})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs(v,{className:"text-gray-600 font-normal",children:["Deductions (Advance Received)",c==="ONBOARDED"&&d&&e.jsxs("div",{className:"text-xs text-green-600 font-medium mt-1",children:["Available: ","₹",(m==null?void 0:m.toFixed(2))||"0.00",m>0&&e.jsx("button",{onClick:()=>b(Math.min(m,r+x)),className:"ml-2 underline text-blue-600 cursor-pointer hover:text-blue-800",children:"Apply Max"})]})]}),e.jsx(p,{type:"number",placeholder:"0.00",value:w||"",onChange:s=>{const a=parseFloat(s.target.value)||0;m>0&&a>m?(alert(`Cannot deduct more than available advance (${m})`),b(m)):b(a)},className:"w-32 text-right h-8"})]})]}),e.jsxs("div",{className:"flex justify-between text-xl font-bold border-t pt-4 text-purple-900",children:[e.jsx("span",{children:"Net Payable"}),e.jsx("span",{children:H.toFixed(2)})]}),e.jsxs(h,{className:"w-full",size:"lg",onClick:le,disabled:F.isPending,children:[e.jsx(ge,{className:"h-4 w-4 mr-2"}),F.isPending?"Generating...":"Save & Generate Invoice"]})]})]})})]})},Ae=()=>{const M=J(),[c,O]=n.useState(null),d=n.useRef(null),{data:C=[],isLoading:D}=X({queryKey:["invoices"],queryFn:async()=>{const{data:t}=await E.get("/billing/invoices");return t}}),N=ee({mutationFn:async({id:t,status:l})=>await E.patch(`/billing/invoices/${t}/status`,{status:l}),onSuccess:()=>{alert("Invoice Updated Successfully"),M.invalidateQueries({queryKey:["invoices"]})}}),j=()=>{if(d.current){const t=window.open("","","height=800,width=1000");if(t){t.document.write("<html><head><title>Print Invoice</title>"),Array.from(document.styleSheets).forEach(r=>{try{if(r.href)t.document.write(`<link rel="stylesheet" type="text/css" href="${r.href}">`);else if(r.cssRules){const y=Array.from(r.cssRules).map(x=>x.cssText).join("");t.document.write(`<style>${y}</style>`)}}catch(y){console.warn("Could not copy stylesheet",y)}});const u=document.getElementsByTagName("style");for(let r=0;r<u.length;r++)t.document.write(u[r].outerHTML);t.document.write('<script src="https://cdn.tailwindcss.com"><\/script>'),t.document.write('</head><body class="bg-white">'),t.document.write(d.current.innerHTML),t.document.write("</body></html>"),t.document.close(),t.focus(),setTimeout(()=>{t.print()},1e3)}}},B=async()=>{if(d.current){document.body.classList.add("pdf-mode");const t=await Ce(d.current,{scale:2,useCORS:!0,logging:!1,width:794,height:1123,windowWidth:794});document.body.classList.remove("pdf-mode");const l=t.toDataURL("image/png"),u=new De({orientation:"portrait",unit:"mm",format:"a4"});u.addImage(l,"PNG",0,0,210,297),u.save(`Invoice_${c.invoice_number}.pdf`)}},S=t=>{const l=`Here is your invoice ${t.invoice_number} for Amount ${Z(t.net_payable)}.`;window.open(`https://wa.me/?text=${encodeURIComponent(l)}`,"_blank")};return e.jsxs(_,{children:[e.jsx(A,{children:e.jsx(P,{children:"Generated Invoices"})}),e.jsx(R,{children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(be,{children:[e.jsx(fe,{children:e.jsxs(U,{children:[e.jsx(f,{children:"Invoice #"}),e.jsx(f,{children:"Client"}),e.jsx(f,{children:"Date"}),e.jsx(f,{children:"Status"}),e.jsx(f,{className:"text-right",children:"Amount"}),e.jsx(f,{className:"text-right",children:"Actions"})]})}),e.jsx(Ne,{children:C.length===0?e.jsx(U,{children:e.jsx(g,{colSpan:6,className:"text-center py-8",children:"No invoices generated yet."})}):C.map(t=>e.jsxs(U,{children:[e.jsx(g,{className:"font-mono font-medium",children:t.invoice_number}),e.jsx(g,{children:t.client_name}),e.jsx(g,{children:V(new Date(t.invoice_date),"dd MMM yyyy")}),e.jsx(g,{children:e.jsx(ye,{variant:"outline",className:t.status==="PAID"||t.status==="SUBMITTED"?"bg-green-100 text-green-700":"bg-gray-100 text-gray-700",children:t.status})}),e.jsx(g,{className:"text-right font-bold",children:Z(t.net_payable)}),e.jsx(g,{className:"text-right",children:e.jsxs("div",{className:"flex justify-end gap-2",children:[t.status==="DRAFT"&&e.jsxs(h,{variant:"outline",size:"sm",onClick:()=>N.mutate({id:t.id,status:"SUBMITTED"}),className:"text-blue-600 border-blue-200 hover:bg-blue-50 hover:text-blue-700 h-8 px-2",children:[e.jsx(Se,{className:"h-3.5 w-3.5 mr-1"})," Submit"]}),e.jsxs(ue,{children:[e.jsx(me,{asChild:!0,children:e.jsx(h,{variant:"ghost",size:"icon",onClick:()=>O(t),children:e.jsx(he,{className:"h-4 w-4"})})}),e.jsx(xe,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:c&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-end gap-2 border-b pb-4",children:[e.jsxs(h,{variant:"outline",size:"sm",onClick:j,children:[e.jsx(Te,{className:"h-4 w-4 mr-2"})," Print"]}),e.jsxs(h,{variant:"outline",size:"sm",onClick:B,children:[e.jsx(pe,{className:"h-4 w-4 mr-2"})," Download PDF"]}),c.status==="DRAFT"&&e.jsxs(h,{size:"sm",onClick:()=>N.mutate({id:c.id,status:"SUBMITTED"}),children:[e.jsx(je,{className:"h-4 w-4 mr-2"})," Submit & Lock"]})]}),e.jsx("div",{className:"border p-1 bg-gray-50 flex justify-center",children:e.jsx("div",{className:"scale-90 origin-top",children:e.jsx(we,{ref:d,data:c})})})]})})]}),e.jsx(h,{variant:"ghost",size:"icon",onClick:()=>S(t),children:e.jsx(ve,{className:"h-4 w-4"})})]})})]},t.id))})]})})})]})},Ze=()=>e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Client Invoices"}),e.jsx("p",{className:"text-muted-foreground",children:"Generate and manage client invoices."})]}),e.jsxs(ce,{defaultValue:"generate",className:"space-y-4",children:[e.jsxs(re,{className:"bg-transparent gap-2 p-0",children:[e.jsx(K,{value:"generate",className:"data-[state=active]:bg-purple-900 data-[state=active]:text-yellow-400 data-[state=inactive]:bg-yellow-400 data-[state=inactive]:text-purple-900 px-6 py-2 rounded-md font-bold transition-all shadow-sm border-2 border-transparent data-[state=active]:border-yellow-400",children:"Generate New Invoice"}),e.jsx(K,{value:"process",className:"data-[state=active]:bg-purple-900 data-[state=active]:text-yellow-400 data-[state=inactive]:bg-yellow-400 data-[state=inactive]:text-purple-900 px-6 py-2 rounded-md font-bold transition-all shadow-sm border-2 border-transparent data-[state=active]:border-yellow-400",children:"Invoice Process"})]}),e.jsx(Y,{value:"generate",className:"space-y-4",children:e.jsx(_e,{})}),e.jsx(Y,{value:"process",className:"space-y-4",children:e.jsx(Ae,{})})]})]});export{Ze as default};
