generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}


model User {
  id            String     @id @default(uuid())
  email         String     @unique
  password_hash String
  full_name     String
  role          String     // Enum: ADMIN, MANAGER, DM_EXECUTIVE, WEB_SEO_EXECUTIVE, CREATIVE_DESIGNER, OPERATIONS_EXECUTIVE
  department    String     // Enum: CREATIVE, MARKETING, WEB, MANAGEMENT
  avatar_url    String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // Relations
  clientsManaged Client[]  @relation("AccountManager")
  clientsAssigned Client[] @relation("ClientStaff") // New Many-to-Many
  
  // Task Relations
  tasksAssigned  Task[]   @relation("TaskAssignee")
  tasksAssignedBy Task[]  @relation("TaskAssignedBy") // New: Tasks delegated by this user
  tasksReported  Task[]   @relation("TaskReporter")
  
  // Campaign Relations
  campaignsDefaulted Campaign[] @relation("CampaignDefaultAssignee")

  timeLogs       TimeLog[]
  comments       Comment[]
  notifications  Notification[]
  assetsUploaded Asset[]

  // Team Management Relations
  staffProfile   StaffProfile?
  attendance     AttendanceRecord[]
  leaveRequests  LeaveRequest[]
  leaveAllocations LeaveAllocation[]
  payrollSlips   PayrollSlip[]
  
  // Managerial Relations
  subordinates   StaffProfile[] @relation("ReportingManager")
  leaveApprovals LeaveRequest[] @relation("LeaveApprover")
  regularisationApprovals RegularisationRequest[] @relation("RegularisationApprover")
  regularisationRequests  RegularisationRequest[]

  // Sticky Notes
  stickyNotesOwned StickyNote[] @relation("NoteOwner")
  stickyNotePermissions StickyNotePermission[]

  // Meta Integration
  metaToken     MetaToken? @relation("UserMetaToken")

  // Client Portal Access
  linked_client_id String? @unique
  linkedClient     Client? @relation("ClientPortalUser", fields: [linked_client_id], references: [id])
  
  // Invoicing
  created_invoices ClientInvoice[] @relation("InvoiceCreator")
  
  // Content Approvals
  contentApprovals ContentDeliverable[] @relation("ContentApprover")

  // Chat Relations
  chatParticipations ChatParticipant[]
  messagesSent       ChatMessage[]
  readReceipts       ChatReadReceipt[]

  // Launcher Relations
  createdApps       LauncherApp[]           @relation("LauncherAppCreator")
  launcherPreferences UserLauncherPreference[]

  advance_balance Float    @default(0.0)

  // Resignation Relations
  resignations         ResignationRequest[] @relation("ResignationEmployee")
  resignationApprovals ResignationRequest[] @relation("ResignationApprover")

  @@index([role])
  @@index([department])
}

// --- MODULE 5: TEAM & HR MANAGEMENT ---

model StaffProfile {
  id               String   @id @default(uuid())
  staff_number     String   @unique // Immutable Staff ID
  designation      String
  department       String   // Enum: MARKETING, CREATIVE, WEB_SEO, MANAGEMENT, ADMIN
  date_of_joining  DateTime
  
  // Productivity & Performance
  productivity_score Float  @default(0.0) // 0-100 scale (calculated daily/weekly)
  sla_breach_count   Int    @default(0)   // Total tasks breached
  
  // Contact & Personal
  personal_contact String?
  official_contact String?
  whatsapp_number  String?
  personal_email   String?
  official_email   String?  // Should match User.email usually, but specific to HR
  address          String?
  city             String?
  state            String?
  pincode          String?
  date_of_birth    DateTime?
  marital_status   String?
  blood_group      String?  // NEW
  current_address  String?  // NEW
  permanent_address String? // NEW
  work_shift       String?  // NEW
  
  // Emergency
  emergency_contact_name   String?
  emergency_contact_number String?
  
  // Professional
  previous_company String?
  total_experience_years Float? @default(0.0)
  
  // Payroll & Financial
  salary_type      String?  // MONTHLY, DAILY, CONTRACT
  base_salary      Float?
  hra             Float?
  allowances      Float?
  // New Allowances
  conveyance_allowance   Float?
  accommodation_allowance Float?
  
  incentive_eligible Boolean @default(false)
  payroll_status   String   @default("ACTIVE") // ACTIVE, HOLD

  // Bank Details
  bank_name           String?
  account_holder_name String?
  account_number      String?
  ifsc_code           String?
  account_type        String? // SAVINGS, CURRENT
  pan_number          String?
  aadhar_number       String?  // NEW
  payment_method      String?  // NEW

  // UPI Details
  upi_id              String?
  upi_linked_mobile   String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user_id         String @unique
  user            User   @relation(fields: [user_id], references: [id])
  
  reporting_manager_id String?
  reporting_manager    User?   @relation("ReportingManager", fields: [reporting_manager_id], references: [id])

  // Biometric Data
  biometricCredentials BiometricCredential[]

  // Shift Assignments
  shift_assignments StaffShiftAssignment[]
}

model BiometricCredential {
  id           String   @id @default(uuid())
  staff_number String
  finger_index Int      @default(0) // 0-9 usually
  template     String   // Base64 encoded template data
  algorithm    String?  @default("ZK")
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  staff        StaffProfile @relation(fields: [staff_number], references: [staff_number], onDelete: Cascade)

  @@unique([staff_number, finger_index])
}

model AttendanceRecord {
  id          String   @id @default(uuid())
  date        DateTime // Normalized to midnight
  status      String   // PRESENT, ABSENT, HALF_DAY, WFH, LEAVE
  check_in    DateTime?
  check_out   DateTime?
  work_hours  Float?
  shift_snapshot String? // JSON or String "09:00-18:00" for audit
  shift_id       String? // New: ID of the shift used
  criteria_mode  String? // New: GRACE_TIME or HOURS_8
  grace_time_applied Int? // Audit: What grace time was used
  method      String   @default("WEB") // WEB, BIOMETRIC_SYNC
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user_id     String
  user        User     @relation(fields: [user_id], references: [id])

  @@unique([user_id, date])
  @@index([status])
  @@index([date])
}

model LeaveRequest {
  id          String   @id @default(uuid())
  type        String   // CASUAL, SICK, EARNED, UNPAID, MATERNITY/PATERNITY
  start_date  DateTime
  end_date    DateTime
  reason      String
  status      String   @default("PENDING") // PENDING, APPROVED, REJECTED
  rejection_reason String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user_id     String
  user        User     @relation(fields: [user_id], references: [id])
  
  approver_id String?
  approver    User?    @relation("LeaveApprover", fields: [approver_id], references: [id])
}

model RegularisationRequest {
  id          String   @id @default(uuid())
  date        DateTime // The date for which regularisation is requested
  type        String   // LATE_ARRIVAL, EARLY_DEPARTURE, MISSED_PUNCH_IN, MISSED_PUNCH_OUT
  reason      String
  status      String   @default("PENDING") // PENDING, APPROVED, REJECTED
  exceeds_limit Boolean @default(false) // Flag if request exceeded monthly limit
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user_id     String
  user        User     @relation(fields: [user_id], references: [id])
  
  approver_id String?
  approver    User?    @relation("RegularisationApprover", fields: [approver_id], references: [id])
}

model LeaveAllocation {
  id           String   @id @default(uuid())
  year         Int
  casual_leave Float    @default(0.0)
  sick_leave   Float    @default(0.0)
  earned_leave Float    @default(0.0)
  unpaid_leave Float    @default(0.0)
  
  // Custom/Other leave types if needed later, could be JSON or specific cols
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user_id      String
  user         User     @relation(fields: [user_id], references: [id])

  @@unique([user_id, year])
}

model Holiday {
  id          String   @id @default(uuid())
  name        String
  date        DateTime @unique
  description String?
  is_recurring Boolean @default(false) // e.g., Every Sunday
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Shift {
  id               String   @id @default(uuid())
  name             String   // e.g., "General Shift", "Morning Shift"
  start_time       String   // "09:00"
  end_time         String   // "18:00"
  default_grace_time Int    @default(15)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  assignments      StaffShiftAssignment[]
}

model StaffShiftAssignment {
  id        String   @id @default(uuid())
  staff_id  String
  shift_id  String
  from_date DateTime
  to_date   DateTime? // Null = Indefinite (until changed)
  
  grace_time Int?     // Optional Override
  
  is_active Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  staff     StaffProfile @relation(fields: [staff_id], references: [id])
  shift     Shift        @relation(fields: [shift_id], references: [id])
}

model PayrollRun {
  id          String   @id @default(uuid())
  month       Int
  year        Int
  status      String   @default("DRAFT") // DRAFT, LOCKED, PAID
  type        String   @default("MONTHLY") // MONTHLY, TILL_DATE
  total_payout Float   @default(0.0)
  processed_at DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  slips       PayrollSlip[]

  
  @@unique([month, year])
}

model PayrollSlip {
  id              String   @id @default(uuid())
  basic_salary    Float
  hra             Float
  allowances      Float
  incentives      Float    @default(0.0)
  deductions      Float    @default(0.0) // Tax, PF, Leave Deductions
  net_pay         Float
  payment_date    DateTime?
  status          String   @default("PENDING") // PENDING, PAID
  payroll_type    String   @default("MONTHLY") // MONTHLY, TILL_DATE
  createdAt       DateTime @default(now())
  
  payroll_run_id  String
  run             PayrollRun @relation(fields: [payroll_run_id], references: [id])
  
  // Detailed Breakdown
  conveyance_allowance   Float   @default(0.0)
  accommodation_allowance Float   @default(0.0)
  
  advance_salary         Float   @default(0.0)
  
  // LOP & Deductions
  lop_days               Float   @default(0.0) // Auto-calculated
  lop_deduction          Float   @default(0.0) // lop_days * daily_wage
  
  other_deductions       Float   @default(0.0) // Tax, PF, etc.
  
  total_working_days     Int     @default(0)
  
  user_id         String
  user            User       @relation(fields: [user_id], references: [id])
}

model Client {
  id           String   @id @default(uuid())
  client_code  String?  @unique // QCNxxxx
  name         String
  brand_colors String?    // Stored as JSON string
  logo_url     String?
  industry     String?
  status       String   @default("LEAD") // Changed default to LEAD
  
  // New Core Fields
  contact_person String?
  contact_number String?
  company_email  String?
  address        String? // Physical Business Address

  // Operating Location
  operating_country String?
  operating_state   String?
  operating_locations_json String? // JSON Array of { country, state? }

  // Financials
  advance_balance   Float    @default(0.0)

  // New JSON Fields for Extended Data
  service_engagement String? // JSON Array of Strings
  social_links       String? // JSON Object
  competitor_info    String? // JSON Array of Objects
  customer_avatar    String? // JSON Object
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  account_manager_id String?
  account_manager    User?   @relation("AccountManager", fields: [account_manager_id], references: [id])
  
  assigned_staff     User[]  @relation("ClientStaff") // Many-to-Many

  // Content Strategies
  content_strategies ClientContentStrategy[]

  campaigns Campaign[]
  directTasks Task[] // Tasks linked directly (e.g. Internal)
  ad_accounts AdAccount[]
  invoices    Invoice[]

  // Portal Access
  portalUser  User?   @relation("ClientPortalUser")

  // Client Portal Data
  seoLogs            SeoLog[]
  webDevProjects     WebDevProject[]
  metaAdsLogs        MetaAdsLog[]
  googleAdsLogs      GoogleAdsLog[]
  contentDeliverables ContentDeliverable[]
  reports            Report[]
  leads              Lead[]

  @@index([status])
  @@index([account_manager_id])
}

model ClientContentStrategy {
  id        String   @id @default(uuid())
  type      String   // Poster, Reel, etc.
  quantity  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client_id String
  client    Client   @relation(fields: [client_id], references: [id], onDelete: Cascade)
  
  @@unique([client_id, type])
}
model Campaign {
  id         String   @id @default(uuid())
  title      String
  start_date DateTime
  end_date   DateTime
  status     String   @default("PLANNING")
  budget     Float?
  goals      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  client_id String
  client    Client @relation(fields: [client_id], references: [id])
  
  // Automation Rules
  default_assignee_id String?
  default_assignee    User?   @relation("CampaignDefaultAssignee", fields: [default_assignee_id], references: [id])

  tasks       Task[]
  ledgers     Ledger[]
  spend_snapshots SpendSnapshot[]
}

model Task {
  id              String       @id @default(uuid())
  sequence_id     Int          @default(0) // Manually incremented in service
  title           String
  description     String?
  status          String       @default("PLANNED") // Enum: TaskStatus
  priority        String       @default("MEDIUM")  // Enum: TaskPriority
  type            String       @default("GENERIC") // Enum: TaskType
  content_type    String?      // Enum: Content Strategy Type (Poster, Reel, etc.)
  nature          String       @default("NEW")     // Enum: NEW, REWORK
  category        String       @default("CAMPAIGN") // Enum: CAMPAIGN, INTERNAL
  due_date        DateTime?
  start_date      DateTime?
  
  // Advanced Task Fields
  sla_target         DateTime?
  sla_status         String    @default("ON_TRACK") // ON_TRACK, AT_RISK, BREACHED
  actual_start_date  DateTime?
  completed_date     DateTime?
  
  estimated_hours    Float?    // Manual Estimate
  ai_estimated_minutes Int?    // AI Suggestion
  actual_time_minutes  Int     @default(0)
  
  completion_rating    Int?    // 1-5 Stars (Quality Score)
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  campaign_id String?
  campaign    Campaign? @relation(fields: [campaign_id], references: [id])

  client_id   String?
  client      Client?   @relation(fields: [client_id], references: [id])

  parent_task_id String?
  parent_task    Task?   @relation("SubTasks", fields: [parent_task_id], references: [id])
  sub_tasks      Task[]  @relation("SubTasks")
  dependencies   TaskDependency[] @relation("TaskBlocking")
  dependents     TaskDependency[] @relation("TaskBlockedBy")

  assignee_id String?
  assignee    User?   @relation("TaskAssignee", fields: [assignee_id], references: [id])
  
  assigned_by_id String?
  assigned_by    User?   @relation("TaskAssignedBy", fields: [assigned_by_id], references: [id])

  reporter_id String
  reporter    User   @relation("TaskReporter", fields: [reporter_id], references: [id])

  assets   Asset[]
  comments Comment[]
  timeLogs TimeLog[]

  @@index([status])
  @@index([priority])
  @@index([assignee_id])
  @@index([reporter_id])
  @@index([client_id])
  @@index([campaign_id])
  @@index([due_date])
}

model TaskDependency {
  id              String   @id @default(uuid())
  blocking_task_id String
  blocking_task    Task     @relation("TaskBlocking", fields: [blocking_task_id], references: [id], onDelete: Cascade)
  
  blocked_task_id  String
  blocked_task     Task     @relation("TaskBlockedBy", fields: [blocked_task_id], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())

  @@unique([blocking_task_id, blocked_task_id])
}

model Asset {
  id          String   @id @default(uuid())
  original_name String
  file_url    String
  file_type   String
  size_bytes  Int?
  version     Int      @default(1)
  is_approved Boolean  @default(false)
  createdAt   DateTime @default(now())

  task_id String
  task    Task   @relation(fields: [task_id], references: [id], onDelete: Cascade)

  uploader_id String
  uploader    User   @relation(fields: [uploader_id], references: [id])
}

model Comment {
  id                  String   @id @default(uuid())
  content             String
  is_revision_request Boolean  @default(false)
  createdAt           DateTime @default(now())

  task_id String
  task    Task   @relation(fields: [task_id], references: [id], onDelete: Cascade)

  author_id String
  author    User   @relation(fields: [author_id], references: [id])

  parent_comment_id String?
  parent_comment    Comment?  @relation("ThreadedComments", fields: [parent_comment_id], references: [id])
  replies           Comment[] @relation("ThreadedComments")

  @@index([task_id])
}

model TimeLog {
  id               String    @id @default(uuid())
  start_time       DateTime
  end_time         DateTime?
  duration_minutes Int?
  createdAt        DateTime  @default(now())

  task_id String
  task    Task   @relation(fields: [task_id], references: [id], onDelete: Cascade)

  user_id String
  user    User   @relation(fields: [user_id], references: [id])

  @@index([user_id])
  @@index([task_id])
  @@index([start_time])
}

model Notification {
  id        String           @id @default(uuid())
  type      String           // Enum: NotificationType
  message   String
  read      Boolean          @default(false)
  link      String?
  createdAt DateTime         @default(now())

  user_id String
  user    User   @relation(fields: [user_id], references: [id])

  @@index([user_id])
  @@index([read])
}

// --- MODULE 3: ACCOUNTING ---

model AccountHead {
  id          String   @id @default(uuid())
  name        String   @unique
  code        String   @unique
  type        String   // Enum: ASSET, LIABILITY, EQUITY, INCOME, EXPENSE
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  ledgers Ledger[]
}

model Ledger {
  id          String   @id @default(uuid())
  ledger_code String?  @unique // QIXFMLxxxx
  name        String   // Unique constraint handled in logic or compound unique
  entity_type String?  // Enum: CLIENT, USER, INTERNAL, VENDOR, BANK, CASH, INCOME, EXPENSE, ADJUSTMENT
  entity_id   String?  // Optional link to Client/User ID
  
  description String?
  status      String   @default("ACTIVE") // ACTIVE, INACTIVE

  balance     Float    @default(0.0)
  currency    String   @default("INR")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  head_id String
  head    AccountHead @relation(fields: [head_id], references: [id])

  // Relations
  campaign_id String?
  campaign    Campaign? @relation(fields: [campaign_id], references: [id])

  journalLines JournalLine[]
  
  @@unique([name, head_id]) 
  @@index([entity_type, entity_id]) // Crucial for "Find Ledger for Client X"
}

model JournalEntry {
  id           String   @id @default(uuid())
  date         DateTime @default(now())
  description  String
  reference    String?  // Invoice #, Receipt #, etc.
  amount       Float
  type         String   // Enum: RECEIPT, PAYMENT, JOURNAL, CONTRA, INVOICE, EXPENSE
  nature       String   @default("GENERAL") // values: GENERAL, ADVANCE_RECEIVED, ADVANCE_PAID
  transaction_number String? @unique 
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  created_by_id String
  // created_by User ... 

  lines JournalLine[]
  
  invoice Invoice?

  @@index([date]) // Index for time-range filtering
  @@index([type]) // Index for type filtering
}

model JournalLine {
  id        String   @id @default(uuid())
  debit     Float    @default(0.0)
  credit    Float    @default(0.0)
  createdAt DateTime @default(now())

  entry_id String
  entry    JournalEntry @relation(fields: [entry_id], references: [id])

  ledger_id String
  ledger    Ledger @relation(fields: [ledger_id], references: [id])
  
  @@index([ledger_id]) // Index for ledger lookups
}

// --- INVOICING MODULE (Restored) ---

model Invoice {
  id           String   @id @default(uuid())
  invoice_number String @unique
  date         DateTime
  due_date     DateTime
  status       String   @default("DRAFT")
  
  // Financials
  subtotal     Float
  tax_rate     Float    @default(18.0)
  tax_amount   Float
  discount     Float    @default(0.0)
  total_amount Float
  balance_due  Float
  
  notes        String?
  terms        String?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  client_id    String
  client       Client   @relation(fields: [client_id], references: [id])
  
  items        InvoiceItem[]
  
  journal_entry_id String? @unique
  journal_entry    JournalEntry? @relation(fields: [journal_entry_id], references: [id])
}

model InvoiceItem {
  id          String   @id @default(uuid())
  description String
  quantity    Float    @default(1.0)
  unit_price  Float
  amount      Float
  
  invoice_id  String
  invoice     Invoice  @relation(fields: [invoice_id], references: [id], onDelete: Cascade)
}











// --- MODULE 4: AD INTELLIGENCE ---

model AdAccount {
  id           String   @id @default(uuid())
  platform     String   // Enum: GOOGLE, META
  external_id  String   // e.g., 'act_123456789'
  name         String
  status       String   @default("ACTIVE")
  currency     String   @default("INR")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  client_id String
  client    Client @relation(fields: [client_id], references: [id])

  // Credentials are stored in a secure separate vault or encrypted field
  // For MVP, we might store a simple token reference or env var key
  
  campaigns AdCampaign[]
}

model SpendSnapshot {
  id              String   @id @default(uuid())
  date            DateTime // Normalized to midnight UTC or Asia/Kolkata
  spend_micros    BigInt   // Store as BigInt to avoid float precision errors
  impressions     Int      @default(0)
  clicks          Int      @default(0)
  conversions     Int      @default(0)
  revenue         Float    @default(0.0)
  currency        String   @default("INR")
  createdAt       DateTime @default(now())
  
  // Linkage
  campaign_id     String?
  campaign        Campaign? @relation(fields: [campaign_id], references: [id])
  
  ad_account_id   String?
  // ad_account AdAccount...

  @@unique([date, campaign_id]) // One snapshot per campaign per day
}

model Lead {
  id              String   @id @default(uuid())
  client_id       String
  client          Client   @relation(fields: [client_id], references: [id], onDelete: Cascade)
  
  date            DateTime @default(now())
  campaign_name   String?
  phone           String?
  name            String?
  address         String?  // Address/Location
  quality         String?  // Lead quality (e.g. HIGH, MEDIUM, LOW)
  status          String   @default("NEW") // Lead status (NEW, CONTACTED, etc.)
  is_positive     Boolean? // Positive/Negative flag
  
  follow_ups      LeadFollowUp[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([client_id])
}

model LeadFollowUp {
  id          String   @id @default(uuid())
  lead_id     String
  lead        Lead     @relation(fields: [lead_id], references: [id], onDelete: Cascade)
  
  follow_up_number Int      // 1st, 2nd, 3rd...
  status           String   // Status for this particular follow up
  notes            String?
  channel          String?  @default("Phone Call") // WhatsApp, Phone Call, Email
  date            DateTime @default(now())

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([lead_id])
}

// --- MODULE 6: STICKY NOTES SYSTEM ---

model StickyNote {
  id          String   @id @default(uuid())
  title       String?  @default("New Note")
  color       String   @default("#feff9c") // Default Yellow
  
  // Positioning & Sizing (Desktop)
  position_x  Float    @default(50)  
  position_y  Float    @default(50)
  width       Float    @default(250)
  height      Float    @default(300)
  
  is_minimized Boolean @default(false)
  is_visible   Boolean @default(true)
  is_shared    Boolean @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user_id     String
  user        User     @relation("NoteOwner", fields: [user_id], references: [id])
  
  team_id     String? 

  tasks       StickyTask[]
  permissions StickyNotePermission[]
}

model StickyTask {
  id           String   @id @default(uuid())
  content      String
  is_completed Boolean  @default(false)
  completed_at DateTime?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  note_id      String
  note         StickyNote @relation(fields: [note_id], references: [id], onDelete: Cascade)
}

model StickyNotePermission {
  id        String   @id @default(uuid())
  role      String   // EDITOR, VIEWER
  
  createdAt DateTime @default(now())

  note_id   String
  note      StickyNote @relation(fields: [note_id], references: [id], onDelete: Cascade)
  
  user_id   String
  user      User     @relation(fields: [user_id], references: [id])
  
  @@unique([note_id, user_id])
}

// --- MODULE 5: META ADS INTEGRATION ---

model MetaToken {
  id            String   @id @default(uuid())
  access_token  String
  refresh_token String?
  expires_at    DateTime?
  scopes        String?  // e.g. "ads_read,ads_management"
  isActive      Boolean  @default(true)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user_id       String   @unique
  user          User     @relation("UserMetaToken", fields: [user_id], references: [id])
}

model AdCampaign {
  id            String   @id @default(uuid())
  external_id   String   @unique // Renamed from meta_id
  name          String
  status        String   // ACTIVE, PAUSED, ARCHIVED, DELETED
  objective     String?  // OUTCOME_TRAFFIC, OUTCOME_SALES, etc.
  buying_type   String?  // AUCTION, RESERVED
  
  start_time    DateTime?
  end_time      DateTime?
  
  daily_budget    Float?
  lifetime_budget Float?
  spend_cap       Float?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt // Last Synced

  ad_account_id String
  ad_account    AdAccount @relation(fields: [ad_account_id], references: [id])

  ad_sets       AdSet[]
  insights      AdInsight[]
}



model AdSet {
  id            String   @id @default(uuid())
  meta_id       String   @unique
  name          String
  status        String
  start_time    DateTime?
  end_time      DateTime?
  
  daily_budget    Float?
  lifetime_budget Float?
  
  bid_strategy  String?
  billing_event String? // IMPRESSIONS, LINK_CLICKS
  
  targeting     String? // JSON String of targeting spec
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  campaign_id   String
  campaign      AdCampaign @relation(fields: [campaign_id], references: [id], onDelete: Cascade)
  
  ads           AdCreative[]
  insights      AdInsight[]
}

model AdCreative {
  id            String   @id @default(uuid())
  meta_id       String   @unique // This is the AD ID (not Creative ID, for simplicity we treat Ad as leaf)
  creative_id   String?  // The actual creative ID
  name          String
  status        String
  
  // Visuals
  thumbnail_url String?
  body_text     String?
  headline      String?
  call_to_action String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  ad_set_id     String
  ad_set        AdSet    @relation(fields: [ad_set_id], references: [id], onDelete: Cascade)
  
  insights      AdInsight[]
}

model AdInsight {
  id            String   @id @default(uuid())
  date          DateTime // Midnight
  
  spend         Float    @default(0.0)
  impressions   Int      @default(0)
  clicks        Int      @default(0)
  ctr           Float?   @default(0.0)
  cpc           Float?   @default(0.0)
  cpm           Float?   @default(0.0)
  
  conversions          Int      @default(0)
  cost_per_conversion  Float?   @default(0.0)
  
  reach         Int?     @default(0)
  frequency     Float?   @default(0.0)
  
  currency      String   @default("INR")

  // Linkage (Optional levels)
  campaign_id   String
  campaign      AdCampaign @relation(fields: [campaign_id], references: [id], onDelete: Cascade)
  
  ad_set_id     String?
  ad_set        AdSet?     @relation(fields: [ad_set_id], references: [id])
  
  ad_id         String?
  ad            AdCreative? @relation(fields: [ad_id], references: [id])
  
  createdAt     DateTime @default(now())
  
  @@unique([date, campaign_id, ad_set_id, ad_id]) // Unique snapshot per grain
}

// --- MODULE 9: CLIENT INVOICE SYSTEM (NEW) ---

model InvoiceSequence {
  id            String   @id @default(uuid())
  year          Int
  month         Int
  current_count Int      @default(0)
  
  updatedAt     DateTime @updatedAt

  @@unique([year, month])
}

model ClientInvoice {
  id              String   @id @default(uuid())
  invoice_number  String   @unique // QIX-YY-MM-XXX
  
  // Client Details
  client_type     String   @default("ONBOARDED") // ONBOARDED or WALKIN
  client_id       String?
  client_name     String   // Copied from Client or Typed manually
  
  // Dates
  invoice_date    DateTime
  due_date        DateTime
  
  // Financials
  sub_total       Float    @default(0.0) // Sum of items
  
  additions_total Float    @default(0.0)
  additions_desc  String?  // JSON or Text description of extras
  
  deductions_total Float   @default(0.0) // Advance, Discount
  deductions_desc String?
  
  net_payable     Float    @default(0.0)
  
  amount_paid     Float    @default(0.0) // If partial pymt allowed in future
  balance_due     Float    @default(0.0)
  
  status          String   @default("DRAFT") // DRAFT, SUBMITTED, PAID, VOID
  
  notes           String?
  
  // Branding / Audit
  created_by_id   String
  created_by      User     @relation("InvoiceCreator", fields: [created_by_id], references: [id])
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  items           ClientInvoiceItem[]
}

model ClientInvoiceItem {
  id              String        @id @default(uuid())
  
  invoice_id      String
  invoice         ClientInvoice @relation(fields: [invoice_id], references: [id], onDelete: Cascade)
  
  sl_no           Int
  particulars     String        // Service Type
  description     String?       // Detailed text
  
  quantity        Float         @default(1.0)
  rate            Float         @default(0.0)
  amount          Float         @default(0.0)
  
  ledger_id       String?       // Optional link to Ledger Account
}


model ContentDeliverable {
  id              String   @id @default(uuid())
  title           String
  type            String   // POSTER, REEL, BLOG, COPY, LOGO
  status          String   @default("DRAFT") // DRAFT, SUBMITTED, APPROVED, CHANGES_REQUESTED, REJECTED
  
  file_url        String?
  preview_url     String?
  
  feedback        String?
  version         Int      @default(1)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  client_id       String
  client          Client   @relation(fields: [client_id], references: [id])
  
  approver_id     String?
  approver        User?    @relation("ContentApprover", fields: [approver_id], references: [id])
}

model Report {
  id              String   @id @default(uuid())
  title           String
  type            String   // MONTHLY, AD_HOC
  period          String?  // DAILY, WEEKLY, MONTHLY, YEARLY
  services_included String? // JSON Array of service keys
  from_date       DateTime
  to_date         DateTime
  
  file_url        String?
  status          String   @default("GENERATING") // GENERATING, READY, FAILED
  
  createdAt       DateTime @default(now())
  
  client_id       String
  client          Client   @relation(fields: [client_id], references: [id])
}
// --- MODULE 6: CLIENT SERVICE TRACKING (Variable/Manual Logs) ---

model MetaAdsLog {
  id            String   @id @default(uuid())
  client_id     String
  client        Client   @relation(fields: [client_id], references: [id])
  date          DateTime @default(now())
  
  campaign_name String
  objective     String   // e.g. Engagement, Leads, Traffic, Sales
  platform      String   // Facebook, Instagram, Both
  spend         Float    @default(0.0)
  status        String   @default("ACTIVE")
  
  // Dynamic Results stored as JSON to allow flexibility
  // e.g. { "impressions": 1000, "clicks": 50, "leads": 5, "cpl": 20.5 }
  results_json  String   @default("{}") 
  
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model GoogleAdsLog {
  id            String   @id @default(uuid())
  client_id     String
  client        Client   @relation(fields: [client_id], references: [id])
  date          DateTime @default(now())
  
  campaign_name String
  campaign_type String   // Search, Display, Video, PMax
  spend         Float    @default(0.0)
  status        String   @default("ACTIVE")
  
  clicks        Int      @default(0)
  impressions   Int      @default(0)
  conversions   Int      @default(0)
  cpa           Float    @default(0.0) // Cost Per Acquisition
  
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model SeoLog {
  id            String   @id @default(uuid())
  client_id     String
  client        Client   @relation(fields: [client_id], references: [id])
  
  month         Int
  year          Int
  status        String   @default("ACTIVE")
  
  // JSON arrays/objects for structured data
  activities_json       String @default("[]") // List of tasks: On-page, Technical, etc.
  keyword_rankings_json String @default("[]") // [{ keyword: 'xyz', rank: 5, change: '+1' }]
  organic_traffic       Int    @default(0)
  
  summary       String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([client_id, month, year])
}

model WebDevProject {
  id            String   @id @default(uuid())
  client_id     String
  client        Client   @relation(fields: [client_id], references: [id])
  
  project_name  String
  status        String   // PLANNING, DESIGN, DEVELOPMENT, AMENDS, TESTING, DEPLOYED
  
  // Progress Tracking
  milestones_json String @default("[]") // [{ name: 'Design', status: 'COMPLETED', date: '...' }]
  timeline_json   String @default("[]") // For Gantt/Timeline view
  
  staging_url   String?
  live_url      String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// --- MODULE 10: NATIVE CHAT SYSTEM ---

model ChatConversation {
  id            String   @id @default(uuid())
  type          String   // DIRECT, GROUP, CHANNEL
  name          String?  // For Groups/Channels
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastMessageAt DateTime @default(now())
  
  participants  ChatParticipant[]
  messages      ChatMessage[]
}

model ChatParticipant {
  id              String   @id @default(uuid())
  conversation_id String
  conversation    ChatConversation @relation(fields: [conversation_id], references: [id], onDelete: Cascade)
  
  // Participant can be User (Staff) or Client (Portal User)
  // For simplicity and unified Auth, we'll link to User
  // Client portal users rely on the `User` record linked to `Client`
  user_id         String
  user            User     @relation(fields: [user_id], references: [id])
  
  role            String   @default("MEMBER") // ADMIN, MEMBER, READ_ONLY
  joinedAt        DateTime @default(now())
  
  // Track read status per conversation
  lastReadAt      DateTime @default(now())

  @@unique([conversation_id, user_id])
}

model ChatMessage {
  id              String   @id @default(uuid())
  conversation_id String
  conversation    ChatConversation @relation(fields: [conversation_id], references: [id], onDelete: Cascade)
  
  sender_id       String
  sender          User     @relation(fields: [sender_id], references: [id])
  
  type            String   @default("TEXT") // TEXT, IMAGE, FILE, SYSTEM
  content         String?   // SQLite Text
  
  // Attachment Metadata
  file_url        String?
  file_name       String?
  file_size       Int?
  file_type       String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt // For edits?
  
  readReceipts    ChatReadReceipt[]
}

model ChatReadReceipt {
  id         String   @id @default(uuid())
  message_id String
  message    ChatMessage @relation(fields: [message_id], references: [id], onDelete: Cascade)
  
  user_id    String
  user       User     @relation(fields: [user_id], references: [id])
  
  readAt     DateTime @default(now())

  @@unique([message_id, user_id])
}



// --- MODULE 7: APP LAUNCHER ---

model LauncherApp {
  id          String   @id @default(uuid())
  name        String
  icon        String   // specific 3d icon name or url
  type        String   // WEB, LOCAL
  url         String?  // https://...
  command     String?  // protocol:// or custom command
  description String?
  
  is_global   Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  creator_id  String?
  creator     User?    @relation("LauncherAppCreator", fields: [creator_id], references: [id])
  
  preferences UserLauncherPreference[]
}

model UserLauncherPreference {
  id          String   @id @default(uuid())
  
  is_pinned   Boolean  @default(false)
  last_used   DateTime?
  usage_count Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user_id     String
  user        User     @relation(fields: [user_id], references: [id])
  
  app_id      String
  app         LauncherApp @relation(fields: [app_id], references: [id], onDelete: Cascade)
  
  @@unique([user_id, app_id])
}

model TransactionSequence {
  id        String @id @default(uuid())
  year      Int
  month     Int
  last_seq  Int    @default(0)

  @@unique([year, month])
}
// --- MODULE 6: RESIGNATION / OFFBOARDING ---

model ResignationRequest {
  id String @id @default(uuid())

  // Employee Relation
  employee_id String
  employee    User   @relation("ResignationEmployee", fields: [employee_id], references: [id])

  // Dates
  applied_date            DateTime  @default(now())
  requested_relieving_date DateTime
  approved_relieving_date  DateTime? // Set upon approval or override

  // Notice Period Logic
  default_notice_period_days Int @default(30)
  revised_notice_period_days Int? // If admin overrides
  final_notice_period_days   Int? // Snapshot of actual days after approval

  // Status & Workflow
  status String @default("APPLIED") // APPLIED, UNDER_NOTICE, COMPLETED, REJECTED, CANCELLED

  // Approval Info
  approval_date DateTime?
  approval_by   String?
  approver      User?     @relation("ResignationApprover", fields: [approval_by], references: [id])

  // Reasons & Logs
  reason           String? // Employee reason
  rejection_reason String?
  revision_reason  String? // Why notice period was changed
  
  // Handover Check (Optional for now)
  handover_completed Boolean @default(false)
  exit_interview_done Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([employee_id])
  @@index([createdAt])
}

model BiometricSyncLog {
  id           String   @id @default(uuid())
  sync_time    DateTime @default(now())
  status       String   // SUCCESS, FAILED
  logs_fetched Int      @default(0)
  logs_saved   Int      @default(0)
  error_msg    String?
  method       String   @default("MANUAL") // MANUAL, AUTO
  
  @@index([sync_time])
}

model BiometricDeviceStatus {
  id              String   @id @default("CURRENT")
  status          String   @default("OFFLINE") // ONLINE, OFFLINE
  last_heartbeat  DateTime @default(now())
  device_info     String?  // JSON string of info
  
  updatedAt       DateTime @updatedAt
}
