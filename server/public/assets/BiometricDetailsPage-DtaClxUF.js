import{r as i,q as k,x as w,j as e,u as z,D as U}from"./index-DTs_gUpQ.js";import{j as K,D as Q,a as V,e as W,f as Y,k as D,B as C,u as M,I as L}from"./index-BPHe9uWR.js";import{C as $,a as G,b as J,c as X}from"./card-CkON84C3.js";import{L as x}from"./label-CYspnl4A.js";import{T as Z,a as ee,b,c as l,d as se,e as n}from"./table-D4yQmoYa.js";import{B as ae}from"./badge-CAnxudGq.js";import{S as q,a as B,b as P,c as F,d as o}from"./select-MX7Oli-8.js";import{T as te}from"./textarea-BJzKcLDx.js";import{C as ne}from"./clock-C1wc1VsE.js";import"./index-Bs76HOJd.js";import"./index-D_f1ssGG.js";function re({isOpen:t,onClose:m,date:c,existingStatus:p}){const[y,j]=i.useState("MISSED_PUNCH_IN"),[S,u]=i.useState(""),N=k(),d=K({mutationFn:async()=>{await w.post("/attendance/regularisation/request",{date:c,type:y,reason:S})},onSuccess:()=>{N.invalidateQueries({queryKey:["biometric-logs"]}),N.invalidateQueries({queryKey:["regularisation-requests"]}),m(),alert("Request submitted successfully")},onError:f=>{var h,g;alert(((g=(h=f.response)==null?void 0:h.data)==null?void 0:g.message)||"Failed to submit request")}});return e.jsx(Q,{open:t,onOpenChange:m,children:e.jsxs(V,{children:[e.jsx(W,{children:e.jsxs(Y,{children:["Regularize Attendance: ",D(new Date(c),"MMM dd, yyyy")]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(x,{children:"Issue Type"}),e.jsxs(q,{value:y,onValueChange:j,children:[e.jsx(B,{children:e.jsx(P,{})}),e.jsxs(F,{children:[e.jsx(o,{value:"MISSED_PUNCH_IN",children:"Missed Punch In"}),e.jsx(o,{value:"MISSED_PUNCH_OUT",children:"Missed Punch Out"}),e.jsx(o,{value:"LATE_ARRIVAL",children:"Late Arrival (Tech Issue)"}),e.jsx(o,{value:"EARLY_DEPARTURE",children:"Early Departure (Approved)"}),e.jsx(o,{value:"WORK_FROM_HOME",children:"Work From Home (Not marked)"}),e.jsx(o,{value:"OTHER",children:"Other"})]})]})]}),e.jsxs("div",{children:[e.jsx(x,{children:"Reason"}),e.jsx(te,{placeholder:"Why is regularization needed?",value:S,onChange:f=>u(f.target.value)}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Note: You have a monthly limit of 3 requests. Exceeding this will flag your request for stricter review."})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(C,{variant:"outline",onClick:m,children:"Cancel"}),e.jsx(C,{onClick:()=>d.mutate(),disabled:d.isPending,children:d.isPending?"Submitting...":"Submit Request"})]})]})]})})}function ge(){const{user:t}=z(),m=k(),c=(t==null?void 0:t.role)==="ADMIN"||(t==null?void 0:t.role)==="MANAGER"||(t==null?void 0:t.role)==="DEVELOPER_ADMIN",[p,y]=i.useState(new Date().toISOString().split("T")[0]),[j,S]=i.useState(new Date().toISOString().split("T")[0]),[u,N]=i.useState(""),[d,f]=i.useState("ALL"),[h,g]=i.useState(null),[v,E]=i.useState(!1),T=async()=>{if(!v){E(!0);try{const s=await w.post("/attendance/biometric/sync-all",{},{timeout:12e4});return m.invalidateQueries({queryKey:["biometric-logs"]}),s.data}catch(s){throw console.error("Sync Failed:",s),s}finally{E(!1)}}};i.useEffect(()=>{c&&(async()=>{try{console.log("Auto-Syncing Biometric Logs..."),await T()}catch(a){console.warn("Auto-Sync Failed (Silently)",a)}})()},[c]);const{data:_}=M({queryKey:["staff-list"],queryFn:async()=>{var a;return(a=(await w.get("/team/staff")).data)==null?void 0:a.filter(r=>{var I;return((I=r.user)==null?void 0:I.full_name)!=="Biometric Bridge Agent"})},enabled:c}),{data:A,isLoading:H}=M({queryKey:["biometric-logs",p,j,d],queryFn:async()=>{let s=`/attendance/biometric-logs?start=${p}&end=${j}`;return d!=="ALL"&&(s+=`&userId=${d}`),(await w.get(s)).data}}),R=i.useMemo(()=>A?A.filter(s=>s.user_name!=="Biometric Bridge Agent"&&(s.user_name.toLowerCase().includes(u.toLowerCase())||s.staff_number.toLowerCase().includes(u.toLowerCase()))):[],[A,u]),O=s=>{const a=s.status||"ABSENT";return e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx(ae,{variant:a==="PRESENT"?"default":a==="ABSENT"||a==="MISSING_PUNCH"?"destructive":a==="HALF_DAY"?"warning":"secondary",children:a.replace("_"," ")}),s.is_late&&e.jsx("span",{className:"inline-flex items-center gap-1 text-[10px] font-semibold text-orange-600 bg-orange-50 border border-orange-200 rounded px-1.5 py-0.5 w-fit",children:"â° Late Punch"})]})};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex justify-between items-center",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-3xl font-bold tracking-tight",children:"Biometric Details"}),e.jsx("p",{className:"text-muted-foreground",children:"Daily punch logs and shift adherence"})]})}),e.jsxs($,{children:[e.jsx(G,{children:e.jsxs("div",{className:"flex flex-col md:flex-row justify-between gap-4",children:[e.jsxs(J,{className:"text-lg flex items-center gap-2",children:[e.jsx(ne,{className:"w-5 h-5"}),"Attendance Logs"]}),e.jsxs("div",{className:"flex gap-2 items-end flex-wrap",children:[e.jsxs("div",{className:"w-40",children:[e.jsx(x,{children:"Start Date"}),e.jsx(L,{type:"date",value:p,onChange:s=>y(s.target.value)})]}),e.jsxs("div",{className:"w-40",children:[e.jsx(x,{children:"End Date"}),e.jsx(L,{type:"date",value:j,onChange:s=>S(s.target.value)})]}),c&&e.jsxs("div",{className:"w-48",children:[e.jsx(x,{children:"Select Staff"}),e.jsxs(q,{value:d,onValueChange:f,children:[e.jsx(B,{children:e.jsx(P,{placeholder:"All Staff"})}),e.jsxs(F,{children:[e.jsx(o,{value:"ALL",children:"All Staff"}),_==null?void 0:_.map(s=>{var a,r;return e.jsx(o,{value:(a=s.user)==null?void 0:a.id,children:((r=s.user)==null?void 0:r.full_name)||"Unknown"},s.id)})]})]})]}),e.jsxs("div",{className:"w-64",children:[e.jsx(x,{children:"Search Logs"}),e.jsx(L,{placeholder:"Search by name or ID...",value:u,onChange:s=>N(s.target.value)})]}),c&&e.jsx("div",{className:"pb-1",children:e.jsxs(C,{onClick:async()=>{var s,a;try{const r=await T();r&&alert("Success: "+r.message)}catch(r){alert("Sync Failed: "+(((a=(s=r.response)==null?void 0:s.data)==null?void 0:a.error)||r.message))}},disabled:v,className:"gap-2 bg-blue-600 hover:bg-blue-700",children:[e.jsx(U,{className:`w-4 h-4 ${v?"animate-spin":""}`}),v?"Syncing Logs...":"Sync Logs"]})})]})]})}),e.jsx(X,{children:e.jsx("div",{className:"rounded-md border",children:e.jsxs(Z,{children:[e.jsx(ee,{children:e.jsxs(b,{children:[e.jsx(l,{children:"Date"}),e.jsx(l,{children:"Staff Name"}),e.jsx(l,{children:"Staff ID"}),e.jsx(l,{children:"Shift Timing"}),e.jsx(l,{children:"Punch In"}),e.jsx(l,{children:"Punch Out"}),e.jsx(l,{children:"Work Hours"}),e.jsx(l,{children:"Status"}),e.jsx(l,{className:"text-right",children:"Action"})]})}),e.jsx(se,{children:H?e.jsx(b,{children:e.jsx(n,{colSpan:9,className:"text-center h-24",children:"Loading..."})}):R.length===0?e.jsx(b,{children:e.jsx(n,{colSpan:9,className:"text-center h-24",children:"No logs found for selected range."})}):R.map(s=>e.jsxs(b,{children:[e.jsx(n,{children:D(new Date(s.date),"MMM dd, yyyy")}),e.jsx(n,{className:"font-medium",children:s.user_name}),e.jsx(n,{children:s.staff_number}),e.jsx(n,{children:e.jsxs("div",{className:"flex flex-col gap-0.5",children:[e.jsx("span",{className:"text-xs font-semibold text-foreground",children:s.shift_name||"Default"}),e.jsx("span",{className:"text-xs text-muted-foreground font-mono",children:s.shift_schedule}),e.jsxs("span",{className:"text-[10px] text-blue-500",children:["Grace: ",s.grace_time??15," min"]})]})}),e.jsx(n,{children:s.check_in?e.jsx("span",{className:"text-green-600 font-mono",children:D(new Date(s.check_in),"hh:mm aa")}):"-"}),e.jsx(n,{children:s.check_out?e.jsx("span",{className:"text-red-600 font-mono",children:D(new Date(s.check_out),"hh:mm aa")}):"-"}),e.jsx(n,{children:s.work_hours?s.work_hours.toFixed(2)+" hrs":"-"}),e.jsx(n,{children:O(s)}),e.jsx(n,{className:"text-right",children:(s.status==="ABSENT"||s.status==="HALF_DAY"||!s.check_in||!s.check_out)&&e.jsx(C,{variant:"ghost",size:"sm",className:"text-blue-600 hover:text-blue-800",onClick:()=>g(s.date),children:"Regularize"})})]},s.id))})]})})})]}),h&&e.jsx(re,{isOpen:!!h,onClose:()=>g(null),date:h})]})}export{ge as default};
