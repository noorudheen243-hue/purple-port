import{u as M,q as I,J as T,r as c,x as h,j as e}from"./index-_K9dBzXA.js";import{u as b,i as q,S as C,$ as O,B as d,P,X as z,C as F,F as D,Y as K}from"./index-C0_MxDCy.js";import{C as S,a as $,b as H,c as Q}from"./card-BJXC2BmV.js";import{L as V}from"./layers-BqtmfYKt.js";const U=({clientIdProp:o})=>{const{user:r}=M(),E=I(),[k]=T(),l=(r==null?void 0:r.role)==="ADMIN"||(r==null?void 0:r.role)==="MANAGER"||(r==null?void 0:r.role)==="DEVELOPER_ADMIN",[N,v]=c.useState(null),L=k.get("clientId"),s=o||(l?N||L:r==null?void 0:r.linked_client_id),[R,x]=c.useState(!1),[n,A]=c.useState("MONTHLY"),[u,Y]=c.useState(new Date().toISOString().split("T")[0]),[m,p]=c.useState([]),{data:f}=b({queryKey:["clients-list-simple"],queryFn:async()=>(await h.get("/clients")).data,enabled:l&&!o}),{data:i}=b({queryKey:["client-details-reports",s],queryFn:async()=>{if(!s)return null;const{data:t}=await h.get(`/clients/${s}`);return t},enabled:!!s}),y=i?Array.isArray(i.service_engagement)?i.service_engagement:typeof i.service_engagement=="string"?JSON.parse(i.service_engagement):[]:[],{data:w=[],isLoading:G}=b({queryKey:["client-reports",s],queryFn:async()=>{if(l&&!s)return[];const{data:t}=await h.get(`/client-portal/reports?clientId=${s||""}`);return t},enabled:!!s}),j=q({mutationFn:async()=>{if(!s)return;let t=new Date(u),a=new Date(u);if(n==="MONTHLY")t.setDate(1),a=new Date(t),a.setMonth(a.getMonth()+1),a.setDate(0);else if(n==="WEEKLY"){const g=t.getDay(),_=t.getDate()-g+(g===0?-6:1);t.setDate(_),a=new Date(t),a.setDate(a.getDate()+6)}else n==="YEARLY"&&(t.setMonth(0,1),a.setMonth(11,31));await h.post("/client-portal/reports/generate",{clientId:s,from_date:t,to_date:a,type:"GENERATED",period:n,services:m})},onSuccess:()=>{E.invalidateQueries({queryKey:["client-reports"]}),C.fire("Generating","Report generation started. It will appear here shortly.","info"),x(!1),p([])},onError:()=>{C.fire("Error","Failed to start generation","error")}});return l&&!s&&!o?e.jsxs("div",{className:"p-8 space-y-6",children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Performance Reports"}),e.jsxs(S,{className:"max-w-md mx-auto p-6 border-dashed text-center space-y-4",children:[e.jsx("h3",{className:"text-lg font-medium",children:"Select a Client"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Choose a client to view and generate reports for."}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{className:"w-full h-10 pl-3 pr-10 rounded-md border border-input bg-background",onChange:t=>v(t.target.value),value:N||"",children:[e.jsx("option",{value:"",children:"-- Select Client --"}),f==null?void 0:f.sort((t,a)=>t.name.localeCompare(a.name)).map(t=>e.jsxs("option",{value:t.id,children:[t.client_code?`${t.client_code} - `:"",t.name]},t.id))]}),e.jsx(O,{className:"absolute right-3 top-3 h-4 w-4 opacity-50 pointer-events-none"})]})]})]}):e.jsxs("div",{className:"space-y-6 animate-in fade-in relative",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Performance Reports"}),l&&s&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Viewing reports for Client ID: ",s.substring(0,8),"..."]})]}),l&&e.jsxs("div",{className:"flex items-center gap-2",children:[!o&&e.jsx(d,{variant:"outline",size:"sm",onClick:()=>v(null),children:"Change Client"}),e.jsxs(d,{onClick:()=>x(!0),children:[e.jsx(P,{className:"mr-2 h-4 w-4"})," Generate New Report"]})]})]}),R&&e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl w-full max-w-lg overflow-hidden animate-in fade-in zoom-in-95 duration-200",children:[e.jsxs("div",{className:"px-6 py-4 border-b flex justify-between items-center bg-gray-50",children:[e.jsx("h3",{className:"font-bold text-lg",children:"Generate New Report"}),e.jsx("button",{onClick:()=>x(!1),className:"text-gray-400 hover:text-gray-600",children:e.jsx(z,{size:20})})]}),e.jsxs("div",{className:"p-6 space-y-5",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 block",children:"1. Select Period"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:["DAILY","WEEKLY","MONTHLY","YEARLY"].map(t=>e.jsx("button",{onClick:()=>A(t),className:`py-2 px-3 text-sm font-medium rounded-md border text-center transition-colors ${n===t?"bg-blue-50 border-blue-500 text-blue-700":"bg-white border-gray-200 hover:bg-gray-50 text-gray-700"}`,children:t},t))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium text-gray-700 block flex items-center gap-2",children:[e.jsx(F,{size:14}),"2. Select Reference Date"]}),e.jsx("input",{type:"date",className:"w-full border rounded-md px-3 py-2 text-sm",value:u,onChange:t=>Y(t.target.value)}),e.jsx("p",{className:"text-xs text-gray-500 italic",children:n==="MONTHLY"?"Select any date in the target month":n==="WEEKLY"?"Select any date in the target week":n==="YEARLY"?"Select any date in the target year":"Select the specific date"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium text-gray-700 block flex items-center gap-2",children:[e.jsx(V,{size:14}),"3. Include Services"]}),y.length>0?e.jsx("div",{className:"grid grid-cols-2 gap-2 max-h-40 overflow-y-auto p-1",children:y.map(t=>e.jsxs("label",{className:"flex items-center gap-2 text-sm border p-2 rounded cursor-pointer hover:bg-gray-50",children:[e.jsx("input",{type:"checkbox",checked:m.includes(t),onChange:a=>{a.target.checked?p([...m,t]):p(m.filter(g=>g!==t))},className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),e.jsx("span",{className:"capitalize",children:t.replace("_"," ").toLowerCase()})]},t))}):e.jsx("div",{className:"text-sm text-red-500 bg-red-50 p-3 rounded",children:"Client has no active services configured."})]})]}),e.jsxs("div",{className:"px-6 py-4 bg-gray-50 border-t flex justify-end gap-3",children:[e.jsx(d,{variant:"outline",onClick:()=>x(!1),children:"Cancel"}),e.jsx(d,{onClick:()=>j.mutate(),disabled:j.isPending||y.length===0,className:"bg-blue-600 hover:bg-blue-700 text-white",children:j.isPending?"Generating...":"Start Generation"})]})]})}),G?e.jsx("div",{children:"Loading reports..."}):e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:w.length===0?e.jsxs("div",{className:"col-span-3 text-center py-12 border rounded-lg bg-gray-50 border-dashed",children:[e.jsx(D,{className:"mx-auto h-12 w-12 text-gray-300 mb-2"}),e.jsx("p",{className:"text-muted-foreground",children:"No reports generated yet."}),l&&e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:'Click "Generate New Report" to create one.'})]}):w.map(t=>e.jsxs(S,{className:"hover:shadow-md transition-shadow group",children:[e.jsxs($,{className:"flex flex-row items-center justify-between pb-2 bg-gray-50/50 border-b",children:[e.jsx(H,{className:"text-sm font-medium leading-normal truncate pr-2",title:t.title,children:t.title}),e.jsx(D,{className:"h-4 w-4 text-primary"})]}),e.jsxs(Q,{className:"pt-4",children:[e.jsxs("div",{className:"text-xs text-muted-foreground mb-4 space-y-1",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Type:"}),e.jsx("span",{className:"font-medium text-gray-700",children:t.period||"GENERAL"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Created:"}),e.jsx("span",{children:new Date(t.createdAt).toLocaleDateString()})]})]}),e.jsxs("div",{className:"flex justify-between items-center mt-4",children:[e.jsx("span",{className:`text-[10px] font-bold px-2 py-0.5 rounded uppercase tracking-wider ${t.status==="READY"?"bg-green-100 text-green-700":t.status==="GENERATING"?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:t.status}),t.status==="READY"&&t.file_url&&e.jsx("a",{href:t.file_url,target:"_blank",rel:"noreferrer",children:e.jsxs(d,{variant:"ghost",size:"sm",className:"h-7 text-primary hover:text-primary/80 px-2",children:[e.jsx(K,{className:"h-3 w-3 mr-1"})," Download"]})})]})]})]},t.id))})]})};export{U as default};
