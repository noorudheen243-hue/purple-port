generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            String     @id @default(uuid())
  email         String     @unique
  password_hash String
  full_name     String
  designation   String?    // New: Specific job title
  role          String     // Enum: ADMIN, MANAGER, MARKETING_EXEC, DESIGNER, WEB_SEO
  department    String     // Enum: CREATIVE, MARKETING, WEB, MANAGEMENT
  avatar_url    String?
  staff_id_number String?  @unique // New: Staff ID
  joining_date  DateTime?  // New: Date of Joining
  dob           DateTime?  // New: Date of Birth
  address       String?    // New
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // Relations
  clientsManaged Client[]
  tasksAssigned  Task[]   @relation("TaskAssignee")
  tasksReported  Task[]   @relation("TaskReporter")
  timeLogs       TimeLog[]
  comments       Comment[]
  notifications  Notification[]
  assetsUploaded Asset[]
  assetComments  AssetComment[]
}

model Client {
  id           String   @id @default(uuid())
  name         String
  brand_colors String?    // Stored as JSON string
  logo_url     String?
  industry     String?
  contract_type String?   // New: Retainer, Project-based, One-off
  
  client_number String?   @unique
  onboarding_date DateTime?
  address       String?
  contact_person String?
  contact_number String?

  // Social & Strategy
  website       String?
  email         String?
  whatsapp      String?
  facebook      String?
  instagram     String?
  linkedin      String?
  youtube       String?
  
  competitorDetails String? // JSON string
  customerAvatar    String? // Text
  contentSuggestions String? // Text
  referenceLinks    String? // JSON string (array of URLs)

  status       String   @default("ACTIVE")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  account_manager_id String?
  account_manager    User?   @relation(fields: [account_manager_id], references: [id])

  campaigns Campaign[]
  tasks     Task[]
  ad_accounts AdAccount[]
  contentCalendars ContentCalendar[]
  ledgers     Ledger[]
  invoices    Invoice[]
}

model ContentCalendar {
  id           String   @id @default(uuid())
  date         DateTime
  creativeType String   // Enum: CreativeType (POSTER, CAROUSEL, etc.)
  quantity     Int      @default(0)
  completed    Int      @default(0)
  inProgress   Int      @default(0)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  client_id String
  client    Client @relation(fields: [client_id], references: [id], onDelete: Cascade)
}

model Campaign {
  id         String   @id @default(uuid())
  title      String
  start_date DateTime
  end_date   DateTime
  status     String   @default("PLANNING")
  budget     Float?
  goals      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  client_id String
  client    Client @relation(fields: [client_id], references: [id], onDelete: Cascade)



  tasks     Task[]
  ad_groups AdGroup[]
  metrics   CampaignMetric[] // Rollup data for quick access
}

model AdAccount {
  id        String   @id @default(uuid())
  platform  String   // Enum: GOOGLE, META, LINKEDIN
  external_id String // ID on the platform (e.g., 123-456-7890)
  status    String   @default("ACTIVE")
  currency  String   @default("USD")
  
  client_id String
  client    Client @relation(fields: [client_id], references: [id], onDelete: Cascade)
  
  ad_groups AdGroup[]
}

model AdGroup {
  id          String   @id @default(uuid())
  name        String
  external_id String?
  status      String   @default("ENABLED")
  
  campaign_id String
  campaign    Campaign @relation(fields: [campaign_id], references: [id], onDelete: Cascade)
  
  ad_account_id String?
  ad_account    AdAccount? @relation(fields: [ad_account_id], references: [id])
  
  ads         Ad[]
}

model Ad {
  id          String   @id @default(uuid())
  name        String
  external_id String?
  status      String   @default("ENABLED")
  type        String?  // TEXT_AD, RESPONSIVE_DISPLAY_AD, etc.
  
  ad_group_id String
  ad_group    AdGroup @relation(fields: [ad_group_id], references: [id], onDelete: Cascade)
  
  // Creative Linkage
  creative_id String?
  creative    Asset? @relation(fields: [creative_id], references: [id]) // Assuming Asset is Creative for now
  
  snapshots   SpendSnapshot[]
}

model SpendSnapshot {
  id          String   @id @default(uuid())
  date        DateTime // Daily Granularity
  
  ad_id       String
  ad          Ad       @relation(fields: [ad_id], references: [id], onDelete: Cascade)
  
  spend       Float    // Use Decimal in Postgres, Float in SQLite
  impressions Int      @default(0)
  clicks      Int      @default(0)
  conversions Int      @default(0)
  revenue     Float    @default(0)
  
  platform_data String? // JSON string for raw dump
  
  createdAt   DateTime @default(now())
  
  @@unique([ad_id, date]) // Ensure one snapshot per ad per day
}

model CampaignMetric {
  id          String   @id @default(uuid())
  date        DateTime
  campaign_id String
  campaign    Campaign @relation(fields: [campaign_id], references: [id], onDelete: Cascade)
  
  spend       Float
  impressions Int
  clicks      Int
  conversions Int
  revenue     Float
  
  @@unique([campaign_id, date])
}



// --- ACCOUNTING MODULE (Double-Entry, INR) ---

model AuditLog {
  id        String   @id @default(uuid())
  action    String   // UPDATE_BUDGET, DELETE_USER
  entity    String   // CAMPAIGN, USER, JOURNAL_ENTRY
  entity_id String
  user_id   String
  details   String?  // JSON string of before/after
  createdAt DateTime @default(now())
}

model AccountHead {
  id          String   @id @default(uuid())
  code        String   @unique // e.g., 1001
  name        String
  type        String   // ASSET, LIABILITY, EQUITY, INCOME, EXPENSE
  is_system   Boolean  @default(false) // Core accounts cannot be deleted
  
  ledgers     Ledger[]
  journalLines JournalLine[]
}

model Ledger {
  id          String   @id @default(uuid())
  name        String
  type        String   // CLIENT, VENDOR, BANK, GENERAL
  
  account_head_id String
  account_head    AccountHead @relation(fields: [account_head_id], references: [id])
  
  // Entity Links
  client_id   String? 
  client      Client? @relation(fields: [client_id], references: [id], onDelete: SetNull)
  
  balance     Float    @default(0) // Logic handles INR Decimal, Storage is Float in SQLite
  updatedAt   DateTime @updatedAt
}

model JournalEntry {
  id          String   @id @default(uuid())
  date        DateTime
  description String
  reference   String?  // Invoice #, Txn ID
  type        String   // INVOICE, PAYMENT, EXPENSE, JOURNAL
  
  lines       JournalLine[]
  
  createdAt   DateTime @default(now())
  created_by  String

  invoice     Invoice?
}

model JournalLine {
  id          String   @id @default(uuid())
  entry_id    String
  entry       JournalEntry @relation(fields: [entry_id], references: [id], onDelete: Cascade)
  
  account_id  String
  account     AccountHead @relation(fields: [account_id], references: [id])
  
  debit       Float   @default(0)
  credit      Float   @default(0)
  
  description String?
  
  invoice_id  String? // Optional reverse link if needed for auditing line items
}

model Invoice {
  id          String   @id @default(uuid())
  number      String   @unique // INV-2024-001
  date        DateTime
  due_date    DateTime
  status      String   @default("DRAFT") // DRAFT, SENT, PAID, OVERDUE, VOID
  
  client_id   String
  client      Client   @relation(fields: [client_id], references: [id])
  
  items       InvoiceItem[]
  
  subtotal    Float
  tax_rate    Float    @default(0.18) // GST 18% standard
  tax_amount  Float
  total       Float
  
  // Link to Journal Entry
  journal_entry_id String? @unique
  journal_entry    JournalEntry? @relation(fields: [journal_entry_id], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model InvoiceItem {
  id          String   @id @default(uuid())
  description String
  quantity    Int
  unit_price  Float
  amount      Float
  
  invoice_id  String
  invoice     Invoice  @relation(fields: [invoice_id], references: [id], onDelete: Cascade)
}

model Task {
  id              String       @id @default(uuid())
  title           String
  description     String?
  status          String       @default("PLANNED") // Enum: TaskStatus
  priority        String       @default("MEDIUM")  // Enum: TaskPriority
  type            String       @default("GENERIC") // Enum: TaskType
  category        String       @default("GENERIC") // Enum: TaskCategory
  platform        String?      // New: FB, IG, LI, GOOGLE, TIKTOK
  due_date        DateTime?
  start_date      DateTime?
  actual_start_date DateTime?
  completed_date    DateTime?
  estimated_hours Float?
  time_estimate   Float?       // New: Explicit field requested, though estimated_hours existed. unifying.
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  campaign_id String?
  campaign    Campaign? @relation(fields: [campaign_id], references: [id], onDelete: Cascade)

  client_id   String?   // New: Direct link to Client
  client      Client?   @relation(fields: [client_id], references: [id], onDelete: SetNull)

  parent_task_id String?
  parent_task    Task?   @relation("SubTasks", fields: [parent_task_id], references: [id], onDelete: Cascade)
  sub_tasks      Task[]  @relation("SubTasks")
  dependencies   TaskDependency[] @relation("TaskBlocking")
  dependents   TaskDependency[] @relation("TaskBlockedBy")

  assignee_id String?
  assignee    User?   @relation("TaskAssignee", fields: [assignee_id], references: [id], onDelete: SetNull)

  reporter_id String
  reporter    User   @relation("TaskReporter", fields: [reporter_id], references: [id], onDelete: Cascade) // If creator is deleted, maybe delete task? Or SetNull? Usually kept for history, but user asked to 'remove all data'
  
  assets   Asset[]
  comments Comment[]
  timeLogs TimeLog[]

  @@index([assignee_id])
  @@index([status])
  @@index([campaign_id])
  @@index([client_id])
  @@index([createdAt])
}

model TaskDependency {
  id              String   @id @default(uuid())
  blocking_task_id String
  blocking_task    Task     @relation("TaskBlocking", fields: [blocking_task_id], references: [id], onDelete: Cascade)
  
  blocked_task_id  String
  blocked_task     Task     @relation("TaskBlockedBy", fields: [blocked_task_id], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())

  @@unique([blocking_task_id, blocked_task_id])
}

model Asset {
  id          String   @id @default(uuid())
  original_name String
  file_url    String
  file_type   String
  size_bytes  Int?
  version     Int      @default(1)
  is_approved Boolean  @default(false)
  createdAt   DateTime @default(now())

  task_id String
  task    Task   @relation(fields: [task_id], references: [id], onDelete: Cascade)

  uploader_id String
  uploader    User   @relation(fields: [uploader_id], references: [id], onDelete: Cascade)

  comments AssetComment[] // New: Relation to comments on this asset
  ads      Ad[]           // New: Linked ads using this creative
}

model Comment {
  id                  String   @id @default(uuid())
  content             String
  is_revision_request Boolean  @default(false)
  createdAt           DateTime @default(now())

  task_id String
  task    Task   @relation(fields: [task_id], references: [id], onDelete: Cascade)

  author_id String
  author    User   @relation(fields: [author_id], references: [id], onDelete: Cascade)

  parent_comment_id String?
  parent_comment    Comment?  @relation("ThreadedComments", fields: [parent_comment_id], references: [id], onDelete: Cascade)
  replies           Comment[] @relation("ThreadedComments")
}

// New Model for Asset Comments to avoid circular complexity or sparse fields in main Comment
model AssetComment {
  id        String   @id @default(uuid())
  content   String
  x_coord   Float?   // For visual proofing later
  y_coord   Float?
  createdAt DateTime @default(now())

  asset_id  String
  asset     Asset    @relation(fields: [asset_id], references: [id], onDelete: Cascade)

  author_id String
  author    User     @relation(fields: [author_id], references: [id], onDelete: Cascade)
}

model TimeLog {
  id               String    @id @default(uuid())
  start_time       DateTime
  end_time         DateTime?
  duration_minutes Int?
  createdAt        DateTime  @default(now())

  task_id String
  task    Task   @relation(fields: [task_id], references: [id], onDelete: Cascade)

  user_id String
  user    User   @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model Notification {
  id        String           @id @default(uuid())
  type      String           // Enum: NotificationType
  message   String
  read      Boolean          @default(false)
  link      String?
  createdAt DateTime         @default(now())

  user_id String
  user    User   @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([read])
}
